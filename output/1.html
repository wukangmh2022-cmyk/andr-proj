<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>äº¤æ˜“ç»“æ„åˆ†æç³»ç»Ÿ</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
      min-height: 100vh;
      padding: 24px;
      color: #fff;
    }
    .container { max-width: 1400px; margin: 0 auto; }
    .header {
      background: linear-gradient(90deg, #2563eb 0%, #9333ea 100%);
      padding: 48px;
      border-radius: 16px;
      margin-bottom: 24px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    .header h1 { font-size: 36px; margin-bottom: 8px; }
    .header p { color: #93c5fd; font-size: 14px; }
    .card {
      background: #1e293b;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
      border: 1px solid #334155;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    .card h2 { font-size: 20px; margin-bottom: 16px; color: #60a5fa; }
    .input-group { display: grid; grid-template-columns: 2fr 1fr; gap: 16px; }
    textarea {
      width: 100%;
      height: 120px;
      background: #334155;
      border: 1px solid #475569;
      border-radius: 8px;
      padding: 12px;
      color: #fff;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      resize: vertical;
    }
    textarea:focus { outline: none; border-color: #3b82f6; }
    .input-row { display: flex; gap: 16px; flex-direction: column; }
    label { display: block; color: #94a3b8; font-size: 13px; margin-bottom: 8px; }
    input, select {
      width: 100%;
      background: #334155;
      border: 1px solid #475569;
      border-radius: 8px;
      padding: 12px;
      color: #fff;
      font-size: 14px;
    }
    input:focus, select:focus { outline: none; border-color: #3b82f6; }
    button {
      background: #2563eb;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: background 0.2s;
    }
    button:hover { background: #1d4ed8; }
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; margin-bottom: 24px; }
    .stat-card {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    .stat-card.blue { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); }
    .stat-card.purple { background: linear-gradient(135deg, #a855f7 0%, #9333ea 100%); }
    .stat-card.orange { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
    .stat-label { font-size: 13px; color: rgba(255,255,255,0.9); margin-bottom: 8px; }
    .stat-value { font-size: 32px; font-weight: bold; }
    .stat-sub { font-size: 12px; margin-top: 4px; color: rgba(255,255,255,0.8); }
    .chart-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); gap: 24px; margin-bottom: 24px; }
    .chart-container { background: #1e293b; border-radius: 12px; padding: 24px; border: 1px solid #334155; }
    .chart-title { font-size: 18px; margin-bottom: 16px; color: #60a5fa; }
    .line-chart, .bar-chart {
      width: 100%;
      height: 300px;
      position: relative;
      background: #0f172a;
      border-radius: 8px;
      padding: 20px;
    }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 12px; text-align: left; border-bottom: 1px solid #334155; }
    th { color: #94a3b8; font-weight: 500; font-size: 13px; }
    td { color: #e2e8f0; font-size: 14px; }
    tr:hover { background: rgba(51, 65, 85, 0.3); }
    .badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 600;
    }
    .badge.long { background: #10b981; color: white; }
    .badge.short { background: #ef4444; color: white; }
    .profit { color: #10b981; font-weight: 600; }
    .loss { color: #ef4444; font-weight: 600; }
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      background: #1e293b;
      border: 2px dashed #334155;
      border-radius: 12px;
      color: #64748b;
    }
    .empty-state svg { margin: 0 auto 16px; opacity: 0.5; }
    .symbol-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px; }
    .symbol-item {
      background: #334155;
      padding: 16px;
      border-radius: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .symbol-color { width: 16px; height: 16px; border-radius: 4px; margin-right: 12px; }
    canvas { max-width: 100%; }
    @media (max-width: 768px) {
      .input-group { grid-template-columns: 1fr; }
      .chart-grid { grid-template-columns: 1fr; }
      .stats-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>äº¤æ˜“ç»“æ„åˆ†æç³»ç»Ÿ</h1>
      <p>Professional Trading Analytics Dashboard</p>
    </div>

    <div class="card">
      <h2>ğŸ“Š æ•°æ®å¯¼å…¥</h2>
      <div class="input-group">
        <div>
          <label>ç²˜è´´ CSV æ•°æ®ï¼ˆåŒ…å«è¡¨å¤´ï¼‰</label>
          <textarea id="csvInput" placeholder="äº¤æ˜“å¯¹,æ–¹å‘,å€æ•°,å¼€ä»“æ—¶é—´,å¼€ä»“å‡ä»·,å¹³ä»“å‡ä»·,æ”¶ç›Šç‡,æ”¶ç›Š&#10;JUP-USDT-SWAP,å¤š,10,2025/5/23 10:56,0.6155,0.6111,-7.15%,-180&#10;BTC-USDT-SWAP,ç©º,5,2025/5/23 11:20,45000,44500,11.11%,500"></textarea>
          <button onclick="parseData()" style="margin-top: 8px;">è§£ææ•°æ®</button>
        </div>
        <div class="input-row">
          <div>
            <label>åˆå§‹èµ„é‡‘</label>
            <input type="number" id="initialCapital" value="10000">
          </div>
          <div>
            <label>äº¤æ˜“å“ç§ç­›é€‰</label>
            <select id="symbolFilter" onchange="filterData()">
              <option value="å…¨éƒ¨">å…¨éƒ¨</option>
            </select>
          </div>
          <!-- ç§»é™¤æ æ†æ¨¡å¼åˆ‡æ¢ï¼šé»˜è®¤æŸ±å­é«˜åº¦æŒ‰å€æ•°æ”¾å¤§ -->
        </div>
      </div>
    </div>

    <div id="results" style="display:none;">
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-label">æ€»æ”¶ç›Š</div>
          <div class="stat-value" id="totalProfit">0</div>
        </div>
        <div class="stat-card blue">
                            <div class="stat-label">èƒœç‡</div>
          <div class="stat-value" id="winRate">0%</div>
          <div class="stat-sub" id="winLoss">0èƒœ / 0è´Ÿ</div>
        </div>
        <div class="stat-card purple">
          <div class="stat-label">æœ€å¤§å›æ’¤</div>
          <div class="stat-value" id="maxDrawdown">0%</div>
          <div class="stat-sub" id="drawdownAmount">0</div>
        </div>
        <div class="stat-card orange">
          <div class="stat-label">æ€»äº¤æ˜“æ¬¡æ•°</div>
          <div class="stat-value" id="totalTrades">0</div>
          <div class="stat-sub" id="longShort">å¤š:0 ç©º:0</div>
        </div>
      </div>

      <div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); margin-bottom: 24px;">
        <div class="card" style="padding: 16px;">
          <div style="font-size: 13px; color: #94a3b8; margin-bottom: 4px;">å¹³å‡æ”¶ç›Š</div>
          <div style="font-size: 24px; font-weight: bold;" id="avgProfit">0</div>
        </div>
        <div class="card" style="padding: 16px;">
          <div style="font-size: 13px; color: #94a3b8; margin-bottom: 4px;">å¤æ™®æ¯”ç‡</div>
          <div style="font-size: 24px; font-weight: bold;" id="sharpeRatio">0</div>
        </div>
        <div class="card" style="padding: 16px;">
          <div style="font-size: 13px; color: #94a3b8; margin-bottom: 4px;">æ”¶ç›Šå›æ’¤æ¯”</div>
          <div style="font-size: 24px; font-weight: bold;" id="profitDrawdownRatio">0</div>
        </div>
      </div>

      <div class="chart-grid">
        <div class="chart-container" style="position: relative;">
          <div class="chart-title">ğŸ“ˆ èµ„é‡‘æ›²çº¿ & å›æ’¤</div>
          <div style="position:relative;">
            <canvas id="equityChart" width="600" height="300"></canvas>
            <canvas id="equityKlineOverlay" width="600" height="300" style="position:absolute;left:0;top:0;pointer-events:none;"></canvas>
          </div>
          <div id="equityTooltip" class="chart-tooltip"></div>
        </div>
        <div class="chart-container" style="position: relative;">
          <div class="chart-title">ğŸ“Š å¤šç©ºä»“ä½å æ¯”ï¼ˆæŸ±é«˜æŒ‰å€æ•°æ”¾å¤§ï¼‰</div>
          <div style="position:relative;">
            <canvas id="positionChart" width="600" height="300"></canvas>
            <canvas id="positionKlineOverlay" width="600" height="300" style="position:absolute;left:0;top:0;pointer-events:none;"></canvas>
          </div>
          <div id="positionTooltip" class="chart-tooltip"></div>
        </div>
      </div>

      <div class="chart-grid">
        <div class="chart-container" style="position: relative;">
          <div class="chart-title">ğŸ“‰ æœ€å¤§å›æ’¤æ›²çº¿</div>
          <canvas id="drawdownChart" width="600" height="300"></canvas>
        </div>
      </div>

      <div class="card">
        <h2>ğŸ¯ äº¤æ˜“å“ç§åˆ†å¸ƒ</h2>
        <div class="symbol-list" id="symbolList"></div>
      </div>

      <div class="card">
        <h2>ğŸ† TOP 20 å…³é”®äº¤æ˜“</h2>
        <div style="overflow-x: auto;">
          <table id="top20Table">
            <thead>
              <tr>
                <th>æ’å</th>
                <th>äº¤æ˜“å¯¹</th>
                <th>æ–¹å‘</th>
                <th>å€æ•°</th>
                <th>å¼€ä»“æ—¶é—´</th>
                <th style="text-align:right;">æ”¶ç›Šç‡</th>
                <th style="text-align:right;">æ”¶ç›Š</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <div id="emptyState" class="empty-state">
      <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M17 8l-5-5-5 5M12 3v12"/>
      </svg>
      <p style="font-size: 18px; margin-bottom: 8px;">è¯·åœ¨ä¸Šæ–¹ç²˜è´´ CSV æ•°æ®</p>
      <p style="font-size: 14px;">æ ¼å¼ï¼šäº¤æ˜“å¯¹,æ–¹å‘,å€æ•°,å¼€ä»“æ—¶é—´,å¼€ä»“å‡ä»·,å¹³ä»“å‡ä»·,æ”¶ç›Šç‡,æ”¶ç›Š</p>
    </div>
  </div>

  <script>
    let allData = [];
    let filteredData = [];
    let equityChartData = [];
    let positionChartData = [];
    const COLORS = ['#10b981', '#ef4444', '#3b82f6', '#f59e0b', '#8b5cf6', '#ec4899'];

    // åˆå§‹åŒ–å›¾è¡¨äº¤äº’
    window.addEventListener('load', () => {
      const equityCanvas = document.getElementById('equityChart');
      const positionCanvas = document.getElementById('positionChart');
      
      equityCanvas.addEventListener('mousemove', (e) => handleEquityChartHover(e));
      equityCanvas.addEventListener('mouseleave', () => hideTooltip('equityTooltip'));
      
      positionCanvas.addEventListener('mousemove', (e) => handlePositionChartHover(e));
      positionCanvas.addEventListener('mouseleave', () => hideTooltip('positionTooltip'));
    });

    function handleEquityChartHover(e) {
      const canvas = document.getElementById('equityChart');
      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      
      const w = canvas.width;
      const h = canvas.height;
      
      // åˆ¤æ–­æ˜¯å¦åœ¨å›¾è¡¨åŒºåŸŸå†…
      if (x < 40 || x > w - 40 || y < 20 || y > h - 40) {
        hideTooltip('equityTooltip');
        return;
      }
      
      // è®¡ç®—æœ€è¿‘çš„æ•°æ®ç‚¹
      const dataIndex = Math.round(((x - 40) / (w - 80)) * (equityChartData.length - 1));
      if (dataIndex >= 0 && dataIndex < equityChartData.length) {
        const data = equityChartData[dataIndex];
        const trade = filteredData[dataIndex];
        const tooltip = document.getElementById('equityTooltip');
        
        const drawdown = ((data.peak - data.equity) / data.peak * 100).toFixed(2);
        const drawdownAmount = (data.peak - data.equity).toFixed(2);
        
        tooltip.innerHTML = `
          <div style=\"color: #94a3b8; margin-bottom: 4px;\">ç¬¬ ${dataIndex + 1} ç¬”äº¤æ˜“</div>
          <div style=\"color: #fff;\"><strong>äº¤æ˜“å¯¹:</strong> ${trade.äº¤æ˜“å¯¹}</div>
          <div style=\"color: #fff;\"><strong>å…¥åœº/å‡ºåœº:</strong> ${trade.å¼€ä»“å‡ä»·} â†’ ${trade.å¹³ä»“å‡ä»·}</div>
          <div style=\"color: #10b981;\"><strong>è´¦æˆ·æƒç›Š:</strong> ${data.equity.toFixed(2)}</div>
          <div style=\"color: #3b82f6;\"><strong>å†å²å³°å€¼:</strong> ${data.peak.toFixed(2)}</div>
          <div style=\"color: ${drawdown > 0 ? '#ef4444' : '#10b981'};\"><strong>å½“å‰å›æ’¤:</strong> ${drawdown}% (${drawdownAmount})</div>
          <div style=\"color: #94a3b8; font-size: 12px; margin-top: 4px;\">${data.date}</div>
        `;
        
        tooltip.style.left = (e.clientX - rect.left + 15) + 'px';
        tooltip.style.top = (e.clientY - rect.top + 15) + 'px';
        tooltip.classList.add('show');

        // å åŠ Kçº¿ï¼ˆä¸¤å¹…å›¾åŒæ­¥ï¼‰
        const symbol = (function(){
          if (!trade || !trade.äº¤æ˜“å¯¹) return null;
          const m = trade.äº¤æ˜“å¯¹.match(/^([A-Z0-9]+)-USDT/);
          return m ? (m[1] + 'USDT') : null;
        })();
        if (symbol) {
          const baseTs = new Date(trade.å¼€ä»“æ—¶é—´.replace(/\//g,'-')).getTime();
          const win = 6 * 60 * 60 * 1000; // å‰å6å°æ—¶çª—å£
          const start = baseTs - win;
          const end = baseTs + win;
          (async () => {
            try {
              const k = await fetch(`https://api.binance.com/api/v3/klines?symbol=${symbol}&interval=15m&startTime=${start}&endTime=${end}`).then(r=>r.ok?r.json():[]);
              drawKlineOverlay('equityKlineOverlay', k);
              drawKlineOverlay('positionKlineOverlay', k);
            } catch {}
          })();
        }
      }
    }

    function handlePositionChartHover(e) {
      const canvas = document.getElementById('positionChart');
      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      
      const w = canvas.width;
      const h = canvas.height;
      
      if (x < 40 || x > w - 40 || y < 20 || y > h - 40) {
        hideTooltip('positionTooltip');
        return;
      }
      
      const barWidth = Math.max(2, (w - 80) / positionChartData.length);
      const dataIndex = Math.floor((x - 40) / barWidth);
      
      if (dataIndex >= 0 && dataIndex < positionChartData.length) {
        const data = positionChartData[dataIndex];
        const tooltip = document.getElementById('positionTooltip');
        const mode = document.getElementById('positionMode').value;
        
        tooltip.innerHTML = `
          <div style="color: #94a3b8; margin-bottom: 4px;">ç¬¬ ${dataIndex + 1} ç¬”äº¤æ˜“</div>
          <div style="color: ${data.direction === 'å¤š' ? '#10b981' : '#ef4444'};"><strong>æ–¹å‘:</strong> ${data.direction}</div>
          <div style="color: #fff;"><strong>ä»“ä½å æ¯”:</strong> ${data.positionPct.toFixed(2)}%</div>
          <div style="color: #fff;"><strong>æ æ†å€æ•°:</strong> ${data.leverage}x</div>
          <div style="color: #fff;"><strong>æ”¶ç›Š:</strong> ${data.profit.toFixed(2)}</div>
          ${mode === 'leverage' ? `<div style="color: #fbbf24; font-size: 12px; margin-top: 4px;">æ æ†æ¨¡å¼: ${data.positionPct.toFixed(1)}%</div>` : ''}
          <div style="color: #94a3b8; font-size: 12px; margin-top: 4px;">${data.date}</div>
        `;
        
        tooltip.style.left = (e.clientX - rect.left + 15) + 'px';
        tooltip.style.top = (e.clientY - rect.top + 15) + 'px';
        tooltip.classList.add('show');
      }
    }

    function hideTooltip(id) {
      document.getElementById(id).classList.remove('show');
    }

    function parseData() {
      const csv = document.getElementById('csvInput').value.trim();
      if (!csv) return;

      const lines = csv.split('\n');
      allData = [];

      for (let i = 1; i < lines.length; i++) {
        const values = lines[i].split(',');
        if (values.length >= 8) {
          allData.push({
            äº¤æ˜“å¯¹: values[0].trim(),
            æ–¹å‘: values[1].trim(),
            å€æ•°: parseFloat(values[2]) || 1,
            å¼€ä»“æ—¶é—´: values[3].trim(),
            å¼€ä»“å‡ä»·: parseFloat(values[4]) || 0,
            å¹³ä»“å‡ä»·: parseFloat(values[5]) || 0,
            æ”¶ç›Šç‡: parseFloat(values[6].replace('%', '')) || 0,
            æ”¶ç›Š: parseFloat(values[7]) || 0
          });
        }
      }

      updateSymbolFilter();
      filterData();
    }

    function updateSymbolFilter() {
      const symbols = ['å…¨éƒ¨', ...new Set(allData.map(d => d.äº¤æ˜“å¯¹))];
      const select = document.getElementById('symbolFilter');
      select.innerHTML = symbols.map(s => `<option value="${s}">${s}</option>`).join('');
    }

    function filterData() {
      const filter = document.getElementById('symbolFilter').value;
      filteredData = filter === 'å…¨éƒ¨' ? allData : allData.filter(d => d.äº¤æ˜“å¯¹ === filter);
      
      if (filteredData.length > 0) {
        document.getElementById('results').style.display = 'block';
        document.getElementById('emptyState').style.display = 'none';
        updateStats();
        drawCharts();
        updateTop20();
        updateSymbolDistribution();
      }
    }

    function updateStats() {
      const totalProfit = filteredData.reduce((sum, d) => sum + d.æ”¶ç›Š, 0);
      const winTrades = filteredData.filter(d => d.æ”¶ç›Š > 0).length;
      const lossTrades = filteredData.filter(d => d.æ”¶ç›Š < 0).length;
      const winRate = ((winTrades / filteredData.length) * 100).toFixed(2);
      const avgProfit = (totalProfit / filteredData.length).toFixed(2);
      const longTrades = filteredData.filter(d => d.æ–¹å‘ === 'å¤š').length;
      const shortTrades = filteredData.filter(d => d.æ–¹å‘ === 'ç©º').length;

      // è®¡ç®—å›æ’¤
      const initialCapital = parseFloat(document.getElementById('initialCapital').value);
      let equity = initialCapital;
      let peak = initialCapital;
      let maxDrawdown = 0;
      let maxDrawdownAmount = 0;

      filteredData.forEach(d => {
        equity += d.æ”¶ç›Š;
        if (equity > peak) {
          peak = equity;
        }
        const drawdown = ((peak - equity) / peak) * 100;
        if (drawdown > maxDrawdown) {
          maxDrawdown = drawdown;
          maxDrawdownAmount = peak - equity;
        }
      });

      // è®¡ç®—å¤æ™®æ¯”ç‡ï¼ˆç®€åŒ–ç‰ˆï¼‰
      const returns = filteredData.map(d => (d.æ”¶ç›Š / initialCapital) * 100);
      const avgReturn = returns.reduce((a, b) => a + b, 0) / returns.length;
      const variance = returns.reduce((sum, r) => sum + Math.pow(r - avgReturn, 2), 0) / returns.length;
      const stdDev = Math.sqrt(variance);
      const sharpeRatio = stdDev > 0 ? (avgReturn / stdDev).toFixed(2) : '0';

      // æ”¶ç›Šå›æ’¤æ¯”
      const profitDrawdownRatio = maxDrawdown > 0 ? ((totalProfit / initialCapital * 100) / maxDrawdown).toFixed(2) : 'âˆ';

      document.getElementById('totalProfit').textContent = totalProfit.toFixed(2);
      document.getElementById('winRate').textContent = winRate + '%';
      document.getElementById('winLoss').textContent = `${winTrades}èƒœ / ${lossTrades}è´Ÿ`;
      document.getElementById('totalTrades').textContent = filteredData.length;
      document.getElementById('longShort').textContent = `å¤š:${longTrades} ç©º:${shortTrades}`;
      document.getElementById('avgProfit').textContent = avgProfit;
      document.getElementById('maxDrawdown').textContent = maxDrawdown.toFixed(2) + '%';
      document.getElementById('drawdownAmount').textContent = maxDrawdownAmount.toFixed(2);
      document.getElementById('sharpeRatio').textContent = sharpeRatio;
      document.getElementById('profitDrawdownRatio').textContent = profitDrawdownRatio;
    }

    function drawCharts() {
      drawEquityChart();
      drawPositionChart2();
      drawDrawdownChart();
    }

    function drawEquityChart() {
      const canvas = document.getElementById('equityChart');
      const ctx = canvas.getContext('2d');
      const w = canvas.width;
      const h = canvas.height;
      const initialCapital = parseFloat(document.getElementById('initialCapital').value);

      ctx.clearRect(0, 0, w, h);

      let equity = initialCapital;
      let peak = initialCapital;
      
      // è®¡ç®—æƒç›Šå’Œå›æ’¤ç‚¹ï¼ŒåŒæ—¶ä¿å­˜åˆ°å…¨å±€å˜é‡ä¾›tooltipä½¿ç”¨
      equityChartData = [];
      const drawdownPoints = [];
      
      filteredData.forEach((d, i) => {
        equity += d.æ”¶ç›Š;
        if (equity > peak) peak = equity;
        
        equityChartData.push({ 
          x: (i / (filteredData.length - 1)) * (w - 80) + 40, 
          equity: equity,
          peak: peak,
          date: d.å¼€ä»“æ—¶é—´,
          index: i
        });
        
        drawdownPoints.push({
          x: (i / (filteredData.length - 1)) * (w - 80) + 40,
          peak: peak,
          equity: equity
        });
      });

      const maxEquity = Math.max(...equityChartData.map(p => p.equity), ...equityChartData.map(p => p.peak));
      const minEquity = Math.min(...equityChartData.map(p => p.equity), initialCapital);
      const range = maxEquity - minEquity;

      // ç»˜åˆ¶ç½‘æ ¼
      ctx.strokeStyle = '#334155';
      ctx.lineWidth = 1;
      for (let i = 0; i <= 5; i++) {
        const y = (h - 60) * (i / 5) + 20;
        ctx.beginPath();
        ctx.moveTo(40, y);
        ctx.lineTo(w - 40, y);
        ctx.stroke();
      }

      // ç»˜åˆ¶å›æ’¤åŒºåŸŸï¼ˆä»å³°å€¼å¾€ä¸‹çš„çº¢è‰²é˜´å½±ï¼‰
      ctx.fillStyle = 'rgba(239, 68, 68, 0.15)';
      ctx.beginPath();
      
      drawdownPoints.forEach((p, i) => {
        const peakY = h - 40 - ((p.peak - minEquity) / range) * (h - 60);
        const equityY = h - 40 - ((p.equity - minEquity) / range) * (h - 60);
        
        if (i === 0) {
          ctx.moveTo(p.x, peakY);
        } else {
          ctx.lineTo(p.x, peakY);
        }
      });
      
      // åå‘å›åˆ°èµ·ç‚¹ï¼Œå½¢æˆé—­åˆåŒºåŸŸ
      for (let i = drawdownPoints.length - 1; i >= 0; i--) {
        const p = drawdownPoints[i];
        const equityY = h - 40 - ((p.equity - minEquity) / range) * (h - 60);
        ctx.lineTo(p.x, equityY);
      }
      
      ctx.closePath();
      ctx.fill();

      // ç»˜åˆ¶å³°å€¼è™šçº¿ï¼ˆè“è‰²ï¼‰
      ctx.strokeStyle = '#3b82f6';
      ctx.lineWidth = 1;
      ctx.setLineDash([5, 5]);
      ctx.beginPath();
      equityChartData.forEach((p, i) => {
        const x = p.x;
        const y = h - 40 - ((p.peak - minEquity) / range) * (h - 60);
        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
      });
      ctx.stroke();
      ctx.setLineDash([]);

      // ç»˜åˆ¶æƒç›Šæ›²çº¿ï¼ˆç»¿è‰²ç²—çº¿ï¼‰
      ctx.strokeStyle = '#10b981';
      ctx.lineWidth = 2.5;
      ctx.beginPath();
      equityChartData.forEach((p, i) => {
        const x = p.x;
        const y = h - 40 - ((p.equity - minEquity) / range) * (h - 60);
        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
      });
      ctx.stroke();

      // ç»˜åˆ¶åæ ‡è½´æ ‡ç­¾
      ctx.fillStyle = '#9ca3af';
      ctx.font = '12px sans-serif';
      ctx.fillText(minEquity.toFixed(0), 5, h - 35);
      ctx.fillText(maxEquity.toFixed(0), 5, 25);

      // æ·»åŠ å›¾ä¾‹
      ctx.fillStyle = '#10b981';
      ctx.fillRect(w - 150, 20, 20, 3);
      ctx.fillStyle = '#fff';
      ctx.fillText('è´¦æˆ·æƒç›Š', w - 125, 25);
      
      ctx.strokeStyle = '#3b82f6';
      ctx.setLineDash([5, 5]);
      ctx.beginPath();
      ctx.moveTo(w - 150, 42);
      ctx.lineTo(w - 130, 42);
      ctx.stroke();
      ctx.setLineDash([]);
      ctx.fillStyle = '#fff';
      ctx.fillText('å†å²å³°å€¼', w - 125, 45);
      
      ctx.fillStyle = 'rgba(239, 68, 68, 0.3)';
      ctx.fillRect(w - 150, 55, 20, 10);
      ctx.fillStyle = '#fff';
      ctx.fillText('å›æ’¤åŒºåŸŸ', w - 125, 64);
    }

    // æ—§ç‰ˆ drawPositionChart å·²åºŸå¼ƒï¼ˆä¿ç•™å ä½ä»¥ä¾¿å¯¹æ¯”ï¼‰ã€‚

    function updateTop20() {
      const top20 = [...filteredData].sort((a, b) => Math.abs(b.æ”¶ç›Š) - Math.abs(a.æ”¶ç›Š)).slice(0, 20);
      const tbody = document.querySelector('#top20Table tbody');
      
      tbody.innerHTML = top20.map((d, i) => `
        <tr>
          <td>${i + 1}</td>
          <td><strong>${d.äº¤æ˜“å¯¹}</strong></td>
          <td><span class="badge ${d.æ–¹å‘ === 'å¤š' ? 'long' : 'short'}">${d.æ–¹å‘}</span></td>
          <td>${d.å€æ•°}x</td>
          <td>${d.å¼€ä»“æ—¶é—´}</td>
          <td style="text-align:right;" class="${d.æ”¶ç›Šç‡ >= 0 ? 'profit' : 'loss'}">${d.æ”¶ç›Šç‡.toFixed(2)}%</td>
          <td style="text-align:right;" class="${d.æ”¶ç›Š >= 0 ? 'profit' : 'loss'}">${d.æ”¶ç›Š.toFixed(2)}</td>
        </tr>
      `).join('');
    }

    function updateSymbolDistribution() {
      const distribution = {};
      allData.forEach(d => {
        if (!distribution[d.äº¤æ˜“å¯¹]) {
          distribution[d.äº¤æ˜“å¯¹] = { count: 0, profit: 0 };
        }
        distribution[d.äº¤æ˜“å¯¹].count++;
        distribution[d.äº¤æ˜“å¯¹].profit += d.æ”¶ç›Š;
      });

      const list = document.getElementById('symbolList');
      list.innerHTML = Object.entries(distribution).map(([name, data], i) => `
        <div class="symbol-item">
          <div style="display:flex; align-items:center;">
            <div class="symbol-color" style="background:${COLORS[i % COLORS.length]}"></div>
            <strong>${name}</strong>
          </div>
          <div style="text-align:right;">
            <div>${data.count} æ¬¡</div>
            <div class="${data.profit >= 0 ? 'profit' : 'loss'}" style="font-size:12px;">${data.profit.toFixed(2)}</div>
          </div>
        </div>
      `).join('');
    }

    // è¦†ç›–åŸæœ‰çš„ handlePositionChartHoverï¼ŒåŠ å…¥å…¥åœº/å‡ºåœºä¸åŒæ­¥Kçº¿
    function handlePositionChartHover(e) {
      const canvas = document.getElementById('positionChart');
      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      const w = canvas.width;
      const h = canvas.height;
      if (x < 40 || x > w - 40 || y < 20 || y > h - 40) {
        hideTooltip('positionTooltip');
        return;
      }
      const barWidth = Math.max(2, (w - 80) / positionChartData.length);
      const dataIndex = Math.floor((x - 40) / barWidth);
      if (dataIndex < 0 || dataIndex >= positionChartData.length) return;
      const data = positionChartData[dataIndex];
      const trade = filteredData[dataIndex];
      const tooltip = document.getElementById('positionTooltip');
      tooltip.innerHTML = `
        <div style=\"color: #94a3b8; margin-bottom: 4px;\">ç¬¬ ${dataIndex + 1} ç¬”äº¤æ˜“</div>
        <div style=\"color: ${data.direction === 'å¤š' ? '#10b981' : '#ef4444'};\"><strong>æ–¹å‘:</strong> ${data.direction}</div>
        <div style=\"color: #fff;\"><strong>ä»“ä½å æ¯”:</strong> ${data.positionPct.toFixed(2)}%</div>
        <div style=\"color: #fff;\"><strong>æ æ†å€æ•°:</strong> ${data.leverage}x</div>
        <div style=\"color: #fff;\"><strong>æ”¶ç›Š:</strong> ${data.profit.toFixed(2)}</div>
        <div style=\"color: #fff;\"><strong>å…¥åœº/å‡ºåœº:</strong> ${trade.å¼€ä»“å‡ä»·} â†’ ${trade.å¹³ä»“å‡ä»·}</div>
        <div style=\"color: #94a3b8; font-size: 12px; margin-top: 4px;\">${data.date}</div>
      `;
      tooltip.style.left = (e.clientX - rect.left + 15) + 'px';
      tooltip.style.top = (e.clientY - rect.top + 15) + 'px';
      tooltip.classList.add('show');

      // åŒæ­¥åŠ è½½Kçº¿
      if (trade && trade.äº¤æ˜“å¯¹) {
        const m = trade.äº¤æ˜“å¯¹.match(/^([A-Z0-9]+)-USDT/);
        const symbol = m ? (m[1] + 'USDT') : null;
        if (symbol) {
          const baseTs = new Date(trade.å¼€ä»“æ—¶é—´.replace(/\//g,'-')).getTime();
          const win = 6 * 60 * 60 * 1000;
          const start = baseTs - win;
          const end = baseTs + win;
          (async () => {
            try {
              const k = await fetch(`https://api.binance.com/api/v3/klines?symbol=${symbol}&interval=15m&startTime=${start}&endTime=${end}`).then(r=>r.ok?r.json():[]);
              drawKlineOverlay('equityKlineOverlay', k);
              drawKlineOverlay('positionKlineOverlay', k);
            } catch {}
          })();
        }
      }
    }

    // æ–°ç‰ˆï¼šæŸ±é«˜é»˜è®¤æŒ‰æ æ†å€æ•°æ”¾å¤§
    function drawPositionChart2() {
      const canvas = document.getElementById('positionChart');
      const ctx = canvas.getContext('2d');
      const w = canvas.width;
      const h = canvas.height;
      const initialCapital = parseFloat(document.getElementById('initialCapital').value);

      ctx.clearRect(0, 0, w, h);

      const barWidth = Math.max(2, (w - 80) / filteredData.length);
      let cumulative = initialCapital;
      let maxPositionPct = 0;

      positionChartData = [];
      filteredData.forEach(d => {
        const baseEquity = cumulative;
        cumulative += d.æ”¶ç›Š;
        const positionValue = Math.abs(d.æ”¶ç›Š) / (Math.abs(d.æ”¶ç›Šç‡) / 100);
        const positionPct = (positionValue * d.å€æ•°) / baseEquity * 100;
        maxPositionPct = Math.max(maxPositionPct, positionPct);
        positionChartData.push({
          direction: d.æ–¹å‘,
          positionPct,
          leverage: d.å€æ•°,
          profit: d.æ”¶ç›Š,
          date: d.å¼€ä»“æ—¶é—´
        });
      });

      const yMax = Math.max(100, Math.ceil(maxPositionPct / 100) * 100);

      // ç½‘æ ¼ä¸Yè½´
      ctx.strokeStyle = '#334155';
      ctx.lineWidth = 1;
      ctx.fillStyle = '#9ca3af';
      ctx.font = '12px sans-serif';
      for (let i = 0; i <= 5; i++) {
        const y = (h - 60) * (i / 5) + 20;
        const labelValue = yMax * (1 - i / 5);
        ctx.beginPath();
        ctx.moveTo(40, y);
        ctx.lineTo(w - 40, y);
        ctx.stroke();
        ctx.fillText(labelValue.toFixed(0) + '%', 5, y + 4);
      }

      // æŸ±ä½“
      positionChartData.forEach((pos, i) => {
        const barHeight = (pos.positionPct / yMax) * (h - 60);
        const x = 40 + i * barWidth;
        const y = h - 40 - barHeight;
        ctx.fillStyle = pos.direction === 'å¤š' ? '#10b981' : '#ef4444';
        ctx.fillRect(x, y, barWidth - 1, barHeight);
      });

      // Xè½´ä¸å›¾ä¾‹
      ctx.strokeStyle = '#334155';
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(40, h - 40);
      ctx.lineTo(w - 40, h - 40);
      ctx.stroke();

      ctx.fillStyle = '#10b981';
      ctx.fillRect(w - 120, 20, 15, 15);
      ctx.fillStyle = '#fff';
      ctx.fillText('å¤šä»“', w - 100, 32);
      ctx.fillStyle = '#ef4444';
      ctx.fillRect(w - 120, 40, 15, 15);
      ctx.fillStyle = '#fff';
      ctx.fillText('ç©ºä»“', w - 100, 52);
      ctx.fillStyle = '#fbbf24';
      ctx.fillText(`æœ€å¤§: ${maxPositionPct.toFixed(1)}%`, w - 120, 72);
    }

    // å›æ’¤æ›²çº¿
    function drawDrawdownChart() {
      const canvas = document.getElementById('drawdownChart');
      if (!canvas) return;
      const ctx = canvas.getContext('2d');
      const w = canvas.width;
      const h = canvas.height;
      const initialCapital = parseFloat(document.getElementById('initialCapital').value);

      ctx.clearRect(0, 0, w, h);
      let equity = initialCapital;
      let peak = initialCapital;
      const dd = [];
      filteredData.forEach((d, i) => {
        equity += d.æ”¶ç›Š;
        if (equity > peak) peak = equity;
        const pct = peak > 0 ? (peak - equity) / peak * 100 : 0;
        dd.push({ x: (i / Math.max(1, filteredData.length - 1)) * (w - 80) + 40, y: pct });
      });
      const yMax = Math.max(10, Math.ceil(Math.max(...dd.map(p => p.y)) / 10) * 10);
      // è½´
      ctx.strokeStyle = '#334155';
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(40, 20);
      ctx.lineTo(40, h - 40);
      ctx.lineTo(w - 40, h - 40);
      ctx.stroke();
      // ç½‘æ ¼ä¸åˆ»åº¦
      ctx.fillStyle = '#9ca3af';
      ctx.font = '12px sans-serif';
      for (let i = 0; i <= 5; i++) {
        const pct = yMax * (i / 5);
        const y = 20 + (h - 60) * (i / 5);
        ctx.fillText(pct.toFixed(0) + '%', 5, y + 4);
        ctx.strokeStyle = '#334155';
        ctx.beginPath();
        ctx.moveTo(40, y);
        ctx.lineTo(w - 40, y);
        ctx.stroke();
      }
      // çº¿
      ctx.strokeStyle = '#f97316';
      ctx.lineWidth = 2;
      ctx.beginPath();
      dd.forEach((p, i) => {
        const y = 20 + (p.y / yMax) * (h - 60);
        if (i === 0) ctx.moveTo(p.x, y);
        else ctx.lineTo(p.x, y);
      });
      ctx.stroke();
    }

    // å åŠ Kçº¿ï¼ˆå–æ”¶ç›˜ä»·ç”»çº¿ï¼‰
    function drawKlineOverlay(canvasId, klines) {
      const canvas = document.getElementById(canvasId);
      if (!canvas || !klines || klines.length === 0) return;
      const ctx = canvas.getContext('2d');
      const w = canvas.width;
      const h = canvas.height;
      ctx.clearRect(0, 0, w, h);
      const closes = klines.map(k => parseFloat(k[4]));
      const min = Math.min(...closes);
      const max = Math.max(...closes);
      if (!isFinite(min) || !isFinite(max) || max === min) return;
      ctx.strokeStyle = 'rgba(147, 197, 253, 0.8)';
      ctx.lineWidth = 1.5;
      ctx.beginPath();
      closes.forEach((c, i) => {
        const x = 40 + (i / (closes.length - 1)) * (w - 80);
        const y = 20 + (1 - (c - min) / (max - min)) * (h - 60);
        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
      });
      ctx.stroke();
    }
  </script>
</body>
</html>
