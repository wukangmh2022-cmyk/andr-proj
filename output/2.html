<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>SVG 交互式蒸汽火车</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #333;
            display: flex;
            flex-direction: column;
            align-items: center;
            font-family: 'Segoe UI', sans-serif;
        }

        .scene-container {
            position: relative;
            width: 100%;
            height: 500px;
            background: #87CEEB; /* 天空蓝 */
            border-bottom: 5px solid #444;
            overflow: hidden;
        }

        /* 所有的SVG元素 */
        svg {
            width: 100%;
            height: 100%;
            display: block;
        }

        /* 控制面板 */
        .controls {
            background: #222;
            width: 100%;
            padding: 15px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            color: white;
            box-shadow: 0 -5px 15px rgba(0,0,0,0.5);
            z-index: 10;
        }

        input[type=range] {
            width: 300px;
            cursor: pointer;
        }

        .speed-meter {
            font-size: 20px;
            font-weight: bold;
            color: #FFD700;
            min-width: 80px;
        }

        /* 简单的CSS抖动动画，用于车身 */
        .shake {
            animation: train-shake 0.5s infinite linear;
        }

        @keyframes train-shake {
            0% { transform: translateY(0px); }
            50% { transform: translateY(1px); }
            100% { transform: translateY(0px); }
        }
    </style>
</head>
<body>

    <div class="scene-container">
        <svg id="main-svg" viewBox="0 0 1200 500" preserveAspectRatio="xMidYMid slice">
            <defs>
                <!-- 火车车身渐变 -->
                <linearGradient id="bodyGrad" x1="0%" y1="0%" x2="0%" y2="100%">
                    <stop offset="0%" stop-color="#e74c3c"/>
                    <stop offset="100%" stop-color="#c0392b"/>
                </linearGradient>
                <linearGradient id="metalGrad" x1="0%" y1="0%" x2="100%" y2="0%">
                    <stop offset="0%" stop-color="#555"/>
                    <stop offset="50%" stop-color="#999"/>
                    <stop offset="100%" stop-color="#555"/>
                </linearGradient>
            </defs>

            <!-- 1. 远景层 (山脉) - 移动最慢 -->
            <g id="layer-mountains">
                <!-- 复制两份以实现无限滚动 -->
                <g class="bg-chunk" transform="translate(0,0)">
                    <path d="M0 350 L200 150 L400 350 L550 200 L800 350 L1000 250 L1200 350 L1200 500 L0 500 Z" fill="#5D6D7E"/>
                </g>
                <g class="bg-chunk" transform="translate(1200,0)">
                    <path d="M0 350 L200 150 L400 350 L550 200 L800 350 L1000 250 L1200 350 L1200 500 L0 500 Z" fill="#5D6D7E"/>
                </g>
            </g>

            <!-- 2. 地面/铁轨层 - 移动速度中等 -->
            <g id="layer-ground">
                <rect y="350" width="2400" height="150" fill="#4caf50"/>
                <!-- 枕木组 -->
                <g id="track-ties">
                    <!-- JS会在这里生成枕木 -->
                </g>
                <!-- 铁轨钢条 -->
                <rect x="0" y="370" width="2400" height="5" fill="#888"/>
                <rect x="0" y="400" width="2400" height="5" fill="#888"/>
            </g>

            <!-- 3. 烟雾层 (位于火车后方) -->
            <g id="smoke-container"></g>

            <!-- 4. 火车主体 (位置固定，只做微小抖动) -->
            <g id="train-group" transform="translate(200, 230)">
                
                <!-- 这里的 translateY 会被 JS 控制产生颠簸感 -->
                <g id="train-body-shaker">
                    <!-- 驾驶室 -->
                    <rect x="180" y="-60" width="110" height="140" rx="5" fill="#2c3e50"/>
                    <rect x="190" y="-40" width="40" height="50" fill="#87ceeb"/> <!-- 窗户 -->
                    <rect x="170" y="-70" width="130" height="10" fill="#1a252f"/> <!-- 顶棚 -->

                    <!-- 锅炉主体 -->
                    <rect x="0" y="0" width="200" height="80" rx="5" fill="url(#bodyGrad)"/>
                    <rect x="20" y="0" width="10" height="80" fill="#c0392b" opacity="0.5"/> <!-- 装饰线 -->
                    <rect x="100" y="0" width="10" height="80" fill="#c0392b" opacity="0.5"/>

                    <!-- 烟囱 -->
                    <path d="M30 0 L30 -40 L20 -50 L60 -50 L50 0 Z" fill="#333"/>
                    <ellipse cx="40" cy="-50" rx="20" ry="5" fill="#111"/>

                    <!-- 车头排障器 (Cowcatcher) -->
                    <path d="M0 80 L-40 80 L0 30 Z" fill="#555"/>
                    <line x1="-5" y1="80" x2="-5" y2="40" stroke="#333" stroke-width="2"/>
                    <line x1="-15" y1="80" x2="-10" y2="45" stroke="#333" stroke-width="2"/>
                    <line x1="-25" y1="80" x2="-15" y2="50" stroke="#333" stroke-width="2"/>
                    
                    <!-- 前灯 -->
                    <circle cx="5" cy="20" r="10" fill="#f1c40f"/>
                </g>

                <!-- 轮子组 -->
                <!-- 连杆 (Connecting Rod) -->
                <rect id="connect-rod" x="30" y="105" width="180" height="8" fill="#bdc3c7" stroke="#7f8c8d" rx="4"/>

                <!-- 后大轮 -->
                <g class="wheel-group" transform="translate(180, 110)">
                    <circle r="35" fill="#333" stroke="#111" stroke-width="5"/>
                    <circle r="25" fill="none" stroke="#e74c3c" stroke-width="2"/>
                    <g class="spokes">
                        <rect x="-35" y="-2" width="70" height="4" fill="#555"/>
                        <rect x="-2" y="-35" width="4" height="70" fill="#555"/>
                    </g>
                    <!-- 连杆连接点 -->
                    <circle id="pin-back" cx="20" cy="0" r="5" fill="#95a5a6"/> 
                </g>

                <!-- 中大轮 -->
                <g class="wheel-group" transform="translate(100, 110)">
                    <circle r="35" fill="#333" stroke="#111" stroke-width="5"/>
                    <circle r="25" fill="none" stroke="#e74c3c" stroke-width="2"/>
                    <g class="spokes">
                        <rect x="-35" y="-2" width="70" height="4" fill="#555"/>
                        <rect x="-2" y="-35" width="4" height="70" fill="#555"/>
                    </g>
                    <!-- 连杆连接点 -->
                    <circle id="pin-mid" cx="20" cy="0" r="5" fill="#95a5a6"/>
                </g>

                <!-- 前小轮 -->
                <g class="wheel-group-small" transform="translate(20, 125)">
                    <circle r="20" fill="#333" stroke="#111" stroke-width="4"/>
                    <g class="spokes">
                        <rect x="-20" y="-2" width="40" height="4" fill="#555"/>
                        <rect x="-2" y="-20" width="4" height="40" fill="#555"/>
                    </g>
                </g>
            </g>
        </svg>
    </div>

    <div class="controls">
        <label>速度控制:</label>
        <input type="range" id="speedControl" min="0" max="30" value="5" step="0.5">
        <div class="speed-meter" id="speedValue">5 km/h</div>
    </div>

    <script>
        const svg = document.getElementById('main-svg');
        const mountains = document.getElementById('layer-mountains');
        const ground = document.getElementById('layer-ground');
        const trackGroup = document.getElementById('track-ties');
        const wheels = document.querySelectorAll('.wheel-group');
        const smallWheel = document.querySelector('.wheel-group-small');
        const spokes = document.querySelectorAll('.spokes');
        const smokeContainer = document.getElementById('smoke-container');
        const trainBody = document.getElementById('train-body-shaker');
        
        const rod = document.getElementById('connect-rod');
        const pinBack = document.getElementById('pin-back');
        const pinMid = document.getElementById('pin-mid');

        const speedInput = document.getElementById('speedControl');
        const speedValue = document.getElementById('speedValue');

        // --- 初始化枕木 ---
        // 为了让枕木移动，我们在宽范围内画很多条
        let tieContent = '';
        for(let i=0; i<50; i++) {
            tieContent += `<rect x="${i * 60}" y="370" width="10" height="35" fill="#3e2723" stroke="#222"/>`;
        }
        trackGroup.innerHTML = tieContent;

        // --- 状态变量 ---
        let speed = 5; // 初始速度
        let posMountains = 0;
        let posGround = 0;
        let wheelRotation = 0;
        let time = 0;

        speedInput.addEventListener('input', (e) => {
            speed = parseFloat(e.target.value);
            speedValue.textContent = Math.floor(speed * 2) + " km/h"; // 假装是两倍数值
        });

        // --- 游戏主循环 ---
        function animate() {
            time += 0.1;

            // 1. 视差滚动背景
            // 山脉 (慢速)
            posMountains -= speed * 0.2; 
            if (posMountains <= -1200) posMountains = 0; // 无限循环重置
            mountains.setAttribute('transform', `translate(${posMountains}, 0)`);

            // 地面和枕木 (全速)
            // 我们不移动整个group，而是移动里面的pattern位置，或者使用取模
            posGround -= speed;
            if (posGround <= -1200) posGround = 0;
            // 这里为了简单，我们只移动枕木组，因为草地是纯色rect看不出移动
            // 使用 transform 对整个轨道组进行移动，当移出屏幕时瞬间拉回来
            let trackX = posGround % 60; // 60是枕木间距
            trackGroup.setAttribute('transform', `translate(${trackX}, 0)`);


            // 2. 车轮旋转
            if (speed > 0) {
                wheelRotation -= speed * 2; // 速度越快转越快
                
                // 更新大轮子
                wheels.forEach(w => {
                    // 必须围绕圆心旋转
                    const spokes = w.querySelector('.spokes');
                    const pins = w.querySelectorAll('circle[id^="pin"]'); // 连杆钉子
                    
                    // 旋转轮辐
                    spokes.setAttribute('transform', `rotate(${wheelRotation})`);
                    
                    // 旋转连杆连接点 (它需要绕轮心转)
                    // 简单的实现：我们在 group 内部转 spokes, 
                    // 但连接点是偏心的，所以也要转
                    pins.forEach(pin => {
                        pin.setAttribute('transform', `rotate(${wheelRotation})`);
                    });
                });

                // 更新小轮子
                const smSpoke = smallWheel.querySelector('.spokes');
                smSpoke.setAttribute('transform', `rotate(${wheelRotation * 1.75})`); // 小轮子转得更快
            }

            // 3. 连杆联动 (机械动画核心)
            // 连杆不仅要水平移动，还要跟随轮子的偏心钉上下运动
            // 偏心半径大约是 20
            const rad = wheelRotation * (Math.PI / 180);
            const offsetX = Math.cos(rad) * 20; 
            const offsetY = Math.sin(rad) * 20;
            
            // 连杆基础位置是 x=30, y=105。加上偏移量
            rod.setAttribute('transform', `translate(${offsetX}, ${offsetY})`);


            // 4. 车身颠簸 (根据速度和正弦波)
            if (speed > 0) {
                const bounce = Math.sin(time * speed * 0.5) * 1.5; // 速度越快颠簸频率越高
                trainBody.setAttribute('transform', `translate(0, ${bounce})`);
            }

            // 5. 烟雾生成器
            if (speed > 0 && Math.random() < 0.1 + (speed/100)) { // 速度越快烟越多
                createSmoke();
            }
            updateSmoke();

            requestAnimationFrame(animate);
        }

        // --- 烟雾粒子系统 ---
        const particles = [];

        function createSmoke() {
            const p = document.createElementNS("http://www.w3.org/2000/svg", "circle");
            // 烟囱口的大致位置：相对于SVG坐标系
            // 火车主体在 (200, 230)，烟囱口在主体内的 (40, -50)
            // 绝对位置约 x=240, y=180
            const startX = 240;
            const startY = 180;

            p.setAttribute("cx", startX);
            p.setAttribute("cy", startY);
            p.setAttribute("r", 5 + Math.random() * 5);
            p.setAttribute("fill", "#fff");
            p.setAttribute("opacity", 0.6);
            
            smokeContainer.appendChild(p);
            
            particles.push({
                el: p,
                x: startX,
                y: startY,
                vx: -speed * 1.5 - Math.random() * 2, // 向后飘，速度受火车速度影响
                vy: -1 - Math.random() * 1, // 向上飘
                life: 1.0,
                growth: 0.2
            });
        }

        function updateSmoke() {
            for (let i = particles.length - 1; i >= 0; i--) {
                let p = particles[i];
                
                // 物理更新
                p.x += p.vx;
                p.y += p.vy;
                p.life -= 0.01;
                let currentR = parseFloat(p.el.getAttribute("r"));
                p.el.setAttribute("r", currentR + p.growth);

                // 视图更新
                p.el.setAttribute("cx", p.x);
                p.el.setAttribute("cy", p.y);
                p.el.setAttribute("opacity", p.life * 0.6);

                // 销毁
                if (p.life <= 0) {
                    smokeContainer.removeChild(p.el);
                    particles.splice(i, 1);
                }
            }
        }

        // 启动
        animate();

    </script>
</body>
</html>