<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>刷脸登录（老年友好）</title>
  <style>
    :root { font-size: 18px; }
    body { margin:0; font-family: system-ui, -apple-system, "Segoe UI", Roboto; background:#fafafa; color:#111; }
    header { padding:1rem; text-align:center; font-weight:700; font-size:1.3rem; }
    .wrap { padding:1rem; max-width:640px; margin:0 auto; }
    .cam { position:relative; background:#000; border-radius:12px; overflow:hidden; }
    video { width:100%; height:auto; display:block; }
    canvas { display:none; }
    .mask {
      position:absolute; inset:0; pointer-events:none;
      box-shadow: 0 0 0 9999px rgba(0,0,0,.35);
    }
    .oval {
      position:absolute; width:60%; aspect-ratio:3/4; left:20%; top:10%;
      border:4px solid rgba(255,255,255,.9); border-radius:50% / 55%;
    }
    .tips { margin:.75rem 0; font-size:1rem; }
    .btns { display:flex; gap:.75rem; }
    button {
      flex:1; font-size:1.2rem; padding:1rem; border:0; border-radius:12px; cursor:pointer;
      background:#0057ff; color:#fff;
    }
    button.secondary { background:#eaeaea; color:#111; }
    button:disabled { opacity:.6; cursor:not-allowed; }
    .status { margin-top:.75rem; min-height:1.5rem; }
    .consent { font-size:.95rem; color:#333; margin:.5rem 0 1rem; }
    .consent input { transform: scale(1.2); margin-right:.5rem; }
    .alt { text-align:center; margin-top:1rem; }
    .alt a { color:#0057ff; text-decoration:underline; font-size:1.05rem; }
  </style>
</head>
<body>
  <header>刷脸登录</header>
  <div class="wrap">
    <div class="consent">
      <label><input type="checkbox" id="agree" />
        我已阅读并同意仅用于身份核验的人脸采集说明（敏感个人信息，最小化、加密存储，可随时撤回）</label>
    </div>

    <div class="cam" aria-label="相机取景区域">
      <video id="video" playsinline autoplay muted></video>
      <div class="mask"></div><div class="oval" aria-hidden="true"></div>
      <canvas id="canvas"></canvas>
    </div>

    <p class="tips" id="tips">请把脸对准白色椭圆，光线要充足。</p>

    <div class="btns">
      <button id="btnRegister" class="secondary">首次注册（拍照）</button>
      <button id="btnLogin">拍照登录</button>
    </div>
    
    <div class="btns" style="margin-top: 0.5rem;">
      <button onclick="clearDatabase()" style="background:#ff6b6b; color:#fff; flex:1; font-size:1rem; padding:0.75rem; border:0; border-radius:12px; cursor:pointer;">清除向量库</button>
    </div>

    <div class="status" id="status" role="status" aria-live="polite"></div>

    <div class="alt">
      <a href="#" onclick="smsFallback()">相机不可用？用短信验证码登录</a>
    </div>
  </div>

  <script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const statusEl = document.getElementById('status');
    const tipsEl = document.getElementById('tips');
    const agree = document.getElementById('agree');

    let stream;
    // 全局承诺：人脸库与模型加载完成
    let faceReady;

    // Add vector extraction using face-api.js
    async function loadFaceAPI() {
      // Wait for faceapi to be defined
      while (typeof faceapi === 'undefined') {
        await new Promise(resolve => setTimeout(resolve, 100));
      }
      
      try {
        const modelPath = 'https://raw.githubusercontent.com/justadudewhohacks/face-api.js/master/weights';
        await Promise.all([
          faceapi.nets.faceRecognitionNet.loadFromUri(modelPath),
          faceapi.nets.faceLandmark68Net.loadFromUri(modelPath),
          faceapi.nets.tinyFaceDetector.loadFromUri(modelPath)
        ]);
        say('人脸识别模型加载完成');
      } catch (e) {
        console.error('Model loading details:', e);
        say('模型加载失败，请刷新重试: ' + e.message);
        throw e;
      }
    }

    async function getfaceVector(imgElement) {
      // 使用最优参数进行快速检测
      const option = new faceapi.TinyFaceDetectorOptions({ inputSize: 224, scoreThreshold: 0.2 });
      
      console.log('开始人脸检测...');
      const detections = await window.faceapi.detectSingleFace(imgElement, option)
        .withFaceLandmarks()
        .withFaceDescriptor();
        
      if (!detections) {
        throw new Error('未检测到人脸，请确保：\n1. 脸部完全在椭圆框内\n2. 光线充足\n3. 正面面向摄像头\n4. 移除眼镜或帽子等遮挡物');
      }
      
      console.log('人脸检测完成，特征向量长度:', detections.descriptor.length);
      return detections.descriptor;
    }

    // Mock storage functions
    function saveVector(name, vector) {
      const vectors = JSON.parse(localStorage.getItem('faceVectors') || '{}');
      vectors[name] = Array.from(vector);
      localStorage.setItem('faceVectors', JSON.stringify(vectors));
    }

    function findMatch(vector, threshold = 0.75) {
      const vectors = JSON.parse(localStorage.getItem('faceVectors') || '{}');
      for (const [name, stored] of Object.entries(vectors)) {
        const distance = window.faceapi.euclideanDistance(vector, stored);
        if (distance < threshold) return name;
      }
      return null;
    }

    // 清除向量库功能
    function clearDatabase() {
      if (confirm('确定要清除所有注册的人脸数据吗？此操作不可恢复！')) {
        localStorage.removeItem('faceVectors');
        say('向量库已清除！');
        console.log('人脸数据库已清空');
      }
    }

    async function startCamera() {
      if (!navigator.mediaDevices?.getUserMedia) {
        say('当前浏览器不支持相机，请改用短信验证码。'); return;
      }
      try {
        stream = await navigator.mediaDevices.getUserMedia({
          video: {
            facingMode: 'user',
            width: { ideal: 1280 }, height: { ideal: 720 }
          },
          audio: false
        });
        video.srcObject = stream;
        say('相机已开启，请对准取景框。');
        // 尝试打开手电筒（部分安卓支持）
        try {
          const [track] = stream.getVideoTracks();
          await track.applyConstraints({ advanced: [{ torch: true }] });
        } catch {}
      } catch (e) {
        say('无法访问相机：' + (e?.message || e));
      }
    }

    function say(msg) { statusEl.textContent = msg; console.log(msg); }

    function captureBlob(quality=0.9) {
      // 基于 video 帧进行居中裁剪，避免黑边
      const vw = video.videoWidth, vh = video.videoHeight;
      if (!vw || !vh) throw new Error('相机尚未就绪');
      const targetW = 720, targetH = 960; // 竖幅，利于特征提取
      canvas.width = targetW; canvas.height = targetH;
      const ctx = canvas.getContext('2d');
      // letterbox 适配：以短边适配
      const scale = Math.min(vw/targetW, vh/targetH);
      const sw = targetW * scale, sh = targetH * scale;
      const sx = (vw - sw)/2, sy = (vh - sh)/2;
      ctx.drawImage(video, sx, sy, sw, sh, 0, 0, targetW, targetH);
      return new Promise(res => canvas.toBlob(res, 'image/jpeg', quality));
    }

    // Modify upload function to use vectors
    async function upload(url, extra = {}) {
      if (!agree.checked) { say('请先勾选同意说明'); return; }
      try {
        disable(true);
        // 确保人脸库与模型已加载
        if (!faceReady) throw new Error('初始化异常：faceReady 未创建');
        say('正在加载人脸模型...');
        await faceReady;

        say('正在拍照...');
        const blob = await captureBlob(0.9);
        
        // Create temporary image for face-api
        const img = new Image();
        img.src = URL.createObjectURL(blob);
        await new Promise(r => img.onload = r);

        say('正在提取特征...');
        const startTime = Date.now();
        const faceVector = await getfaceVector(img);
        const endTime = Date.now();
        console.log(`特征提取完成，耗时: ${endTime - startTime}ms`);

        if (url.includes('register')) {
          const name = extra.name;
          saveVector(name, faceVector);
          say(`注册成功：${name}`);
        } else {
          const match = findMatch(faceVector);
          if (match) {
            say(`登录成功：${match}`);
            location.href = '/home';
          } else {
            throw new Error('未找到匹配的人脸');
          }
        }

      } catch (e) {
        say('失败：' + (e?.message || e));
      } finally {
        disable(false);
      }
    }

    function disable(b) {
      document.getElementById('btnRegister').disabled = b;
      document.getElementById('btnLogin').disabled = b;
    }

    function smsFallback() {
      alert('将切换到短信验证码登录流程。');
      location.href = '/sms-login';
    }

    document.getElementById('btnRegister').addEventListener('click', () => {
      // 创建一个简单的输入对话框
      const nameInput = document.createElement('input');
      nameInput.type = 'text';
      nameInput.placeholder = '请输入姓名';
      nameInput.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);padding:10px;font-size:16px;border:2px solid #0057ff;border-radius:8px;z-index:1000;';
      
      const overlay = document.createElement('div');
      overlay.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:999;display:flex;align-items:center;justify-content:center;flex-direction:column;';
      
      const confirmBtn = document.createElement('button');
      confirmBtn.textContent = '确认';
      confirmBtn.style.cssText = 'margin-top:10px;padding:8px 16px;background:#0057ff;color:white;border:none;border-radius:4px;cursor:pointer;';
      
      const cancelBtn = document.createElement('button');
      cancelBtn.textContent = '取消';
      cancelBtn.style.cssText = 'margin-top:5px;padding:8px 16px;background:#eaeaea;color:#111;border:none;border-radius:4px;cursor:pointer;';
      
      overlay.appendChild(nameInput);
      overlay.appendChild(confirmBtn);
      overlay.appendChild(cancelBtn);
      document.body.appendChild(overlay);
      
      nameInput.focus();
      
      const handleConfirm = () => {
        const name = nameInput.value.trim();
        if (name) {
          document.body.removeChild(overlay);
          upload('/api/register', { name });
        }
      };
      
      const handleCancel = () => {
        document.body.removeChild(overlay);
      };
      
      confirmBtn.addEventListener('click', handleConfirm);
      cancelBtn.addEventListener('click', handleCancel);
      nameInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') handleConfirm();
        if (e.key === 'Escape') handleCancel();
      });
    });
    document.getElementById('btnLogin').addEventListener('click', () => upload('/api/login'));

    startCamera();
    window.addEventListener('pagehide', () => {
      // 释放摄像头
      stream?.getTracks()?.forEach(t => t.stop());
    });

    // Add face-api.js script and initialize
    say('正在加载人脸识别库...');
    faceReady = new Promise((resolve, reject) => {
      const script = document.createElement('script');
      script.src = 'https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js';
      script.onload = async () => {
        try {
          await loadFaceAPI();
          resolve();
        } catch (e) {
          reject(e);
        }
      };
      script.onerror = (e) => {
        console.error('Face API script load error:', e);
        say('人脸识别库加载失败，请检查网络后重试');
        reject(new Error('face-api script load failed'));
      };
      document.head.appendChild(script);
    });
  </script>
</body>
</html>
